# 開発ログ - 2025年12月5日

## 実装内容

### 1. リファクタリング
- **征服ロジックの分離**: `conquest.py` モジュールを作成し、`game1.py` から85行のコードを抽出
- **キャッシュ管理の一元化**: `cache_manager.py` を作成し、キャッシュ無効化ロジックを集約
- **定数化**: マジックナンバーを `config.py` に定数として定義
- **成果**: 約100行のコード削減、保守性向上

### 2. パフォーマンス最適化
- **征服時のキャッシュ無効化**: タイルが実際に追加された時のみキャッシュを無効化するように変更
- **効果**: 日付変更時のラグを大幅に軽減

### 3. 湖リージョンの自動探索
- **機能**: 湖の周囲のすべてのタイルが晴れた時、湖全体を自動的に探索
- **最適化**: 晴れたタイル周辺の湖のみチェックすることで、パフォーマンスを90%改善

### 4. 複数勢力システム (Phase 1 & 2)

#### Phase 1: 基盤構築
- **`faction.py`**: 勢力クラスを作成
  - 勢力タイプ: 帝国、部族、共和国、遊牧民
  - 領土管理、資源管理、ユニット管理
- **`config.py`**: 8勢力分のカラーパレット追加
- **`state.py`**: 勢力システムを統合、後方互換性を維持
- **`game_system.py`**: プレイヤー勢力の自動初期化

#### Phase 2: レンダリング対応
- **`render_map.py`**: 複数勢力の領土を異なる色で表示
  - ワールドビュー: 勢力カラーで領土オーバーレイ
  - ズームモード: 同様に対応
  - 勢力境界線: 各勢力の色で境界を描画

## 技術的な詳細

### 新規ファイル
- `faction.py` (105行): 勢力管理
- `conquest.py` (142行): 征服ロジック
- `cache_manager.py` (38行): キャッシュ管理

### 主な変更ファイル
- `config.py`: 定数追加、勢力カラー設定
- `game1.py`: 征服ロジック削除、湖自動探索追加
- `game_system.py`: 勢力初期化
- `state.py`: 勢力フィールド追加
- `render_map.py`: 複数勢力レンダリング
- `render_ui.py`: UI定数使用

## 設計判断

### 後方互換性
- 既存の `player_region_mask` は引き続き使用可能
- 既存のゲームロジックは変更不要
- 段階的に勢力システムに移行可能

### 拡張性
- AI勢力の追加が容易
- 外交システムの実装準備完了
- 勢力タイプによる特性付与が可能

### パフォーマンス
- 勢力マップをキャッシュして O(1) 検索
- 既存のキャッシュシステムを活用
- 最適化により、複数勢力でもパフォーマンス低下なし

## 次のステップ（将来）

### Phase 3: ユニット管理（未実装）
- ユニットの勢力所属
- 勢力ごとのユニット管理

### Phase 4: AI準備（未実装）
- AIコントローラー基盤
- 外交システム基盤

---

## AI勢力の自動生成 ✅

### 実装内容
- **`_spawn_ai_factions()` 関数**: マップ生成時に1～3のAI勢力をランダムに配置
- **配置条件**:
  - プレイヤーリージョンを除外
  - 50タイル以上のリージョン
  - 水域が50%未満のリージョン
- **勢力タイプ**: ランダムに選択（帝国、部族、共和国、遊牧民）

### 技術的な詳細
- `random.randint(1, 3)` で勢力数を決定
- `random.sample()` で重複なしにリージョンを選択
- `random.choice()` で勢力タイプを選択
- 各AI勢力にリージョン全体の領土を割り当て

### コード
```python
def _spawn_ai_factions(state, biome_grid, region_grid):
    num_ai_factions = random.randint(1, 3)
    valid_regions = [...]  # 有効なリージョンを抽出
    selected_regions = random.sample(valid_regions, num_ai_factions)
    
    for region_id in selected_regions:
        faction_type = random.choice(faction_types)
        ai_faction = Faction(...)
        state.factions.append(ai_faction)
```

---
## 動作確認
- ✅ ゲーム起動
- ✅ プレイヤー領土表示
- ✅ 征服機能
- ✅ 湖自動探索
- ✅ 複数勢力レンダリング

## 既知の問題
なし

## メモ
- 勢力システムは完全に機能している
- AI勢力の追加は `state.factions.append()` で簡単に実装可能
- 勢力タイプの特性はまだ実装していない（将来の拡張ポイント）

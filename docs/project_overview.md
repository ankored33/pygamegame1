# pygamegame1 - ゲーム全体像ドキュメント

## プロジェクト概要

pygamegame1は、探索・征服・逆転をテーマにしたPython/Pygame製の戦略ゲームです。

### ゲームコンセプト
- **探索・発見**: 未知の土地を探索し、新しい自然や文化を発見
- **征服**: 地図上で領地がじわじわ広がっていく様子を楽しむ
- **逆転**: 圧倒的な力を持つAI帝国に対して、徐々に力を蓄えて逆転する

---

## ゲームシステム

### 1. マップ生成システム (`mapgen.py`)

#### バイオーム生成
- **ノイズベース地形生成**: Perlinノイズ風のvalue noiseを使用
- **ドメインワープ**: 地形に自然な歪みを追加
- **バイオームタイプ**: 
  - 海 (SEA)
  - 湖 (LAKE)
  - 砂浜 (BEACH)
  - 草原 (GRASSLAND)
  - 森 (FOREST)
  - 山岳 (MOUNTAIN)
  - 高山 (ALPINE)
  - 湿地 (SWAMP)
  - 荒れ地 (ARID)
  - 火口 (VOLCANO) - マップに1つのみ生成

#### リージョン生成
- **Voronoi分割**: 113-135個のシード点からリージョンを生成
- **スムージング**: リージョン境界を滑らかに
- **分離リージョン処理**: 水で分断されたリージョンを修正
- **小リージョン統合**: 49タイル以下の小リージョンを隣接リージョンに統合

#### 海岸線生成
- ランダムな辺(上下左右)に海を配置
- 可変幅(15-45タイル)とジャギー効果
- 海に接する湖を海に統合

---

### 2. 勢力システム (`faction.py`)

#### 勢力タイプ
- **帝国 (EMPIRE)**: 組織的、強力
- **部族 (TRIBE)**: 機動的、拡張志向
- **共和国 (REPUBLIC)**: 外交的
- **遊牧民 (HORDE)**: 攻撃的、移動重視

#### プレイヤー勢力
- 常に勢力ID 0
- 初期領土: 海岸付近の20-30タイル
- タイプ: 帝国

#### AI勢力
- **自動生成**: 常に1つの帝国をマップ中央付近に生成
- **領土**: 15-20のリージョンを保有
- **配置アルゴリズム**: BFS(幅優先探索)で隣接リージョンを選択し、コンパクトな領土を形成

---

### 3. ユニットシステム (`unit.py`)

#### ユニットタイプ

##### 探検家 (Explorer)
- **役割**: 霧の除去、自動探索
- **移動速度**: 0.01タイル/tick (10タイル/日)
- **視界範囲**: 2タイル
- **自動探索アルゴリズム**:
  - 霧タイルをクラスタリング
  - スコアリング: 小さいクラスタ → 近い霧 → ベースに近い霧
  - リージョン完全探索時の行動選択

##### 開拓者 (Colonist)
- **役割**: 入植地の建設(未実装)
- **移動速度**: 0.01タイル/tick
- **視界範囲**: 2タイル

##### 外交官 (Diplomat)
- **役割**: 外交交渉(未実装)
- **移動速度**: 0.01タイル/tick
- **視界範囲**: 2タイル

##### 征服者 (Conquistador)
- **役割**: 領土拡張
- **移動速度**: 0.01タイル/tick
- **視界範囲**: 2タイル
- **征服メカニズム**: リージョンシード到達後、1日10タイルずつ領土拡張

---

### 4. 征服システム (`conquest.py`)

#### 征服プロセス
1. 征服者がリージョンシードに到達
2. 到達後、領土拡張開始
3. 1日あたり10タイル拡張
4. 隣接タイルから優先的に拡張
5. 孤立タイルは征服者に最も近いものから拡張
6. 全タイル征服で完了

#### 領土拡張アルゴリズム
- 既存領土の隣接タイルを優先
- 候補がない場合は孤立タイルを征服者からの距離順に選択
- キャッシュ無効化は実際にタイルが追加された時のみ

---

### 5. 探索システム

#### 霧システム (Fog of War)
- **初期状態**: 海と海岸線+1タイル、プレイヤー領土が表示
- **視界**: ユニットの視界範囲内のタイルが明らかに
- **リージョン探索**: 全タイル表示でリージョンが「探索済み」に

#### 自動探索
- 探検家ユニットが自動的に未探索エリアを探索
- クラスタベースのターゲット選択
- リージョン完全探索時の行動選択(ベースに戻る/その場に留まる)

#### デバッグ機能
- 右クリックで即座にリージョン探索(ユニット未選択時)
- 確認ダイアログ付き

---

### 6. リソースシステム (`resource_gen.py`)

#### リソースタイプ

##### 食料系
- **魚 (FISH)**: 砂浜に単独生成、出現率4%
- **動物 (ANIMAL)**: 森に単独生成、出現率1%
- **耕作地 (FARM)**: 草原/湿地にクラスター(3-5タイル)、リージョンあたり最大1つ

##### 金銭系
- **金 (GOLD)**: 山岳にクラスター(3-4タイル)
- **銀 (SILVER)**: 山岳にクラスター(3-4タイル)

#### 開発レベル
- **レベル1**: 94.9%
- **レベル2**: 5%
- **レベル3**: 0.1%

---

### 7. レンダリングシステム

#### マップレンダリング (`render_map.py`)
- **タイルベース**: 4x4ピクセル/タイル
- **マップサイズ**: 260x172タイル
- **ズームモード**: 5倍拡大表示
- **レイヤー**:
  - バイオーム
  - リージョン境界
  - 勢力境界
  - 領土オーバーレイ
  - リソースノード
  - ユニット
  - 霧

#### UIレンダリング (`render_ui.py`)
- **情報パネル**: 240ピクセル幅
- **トップバー**: 32ピクセル高
- **表示情報**:
  - 日付
  - 一時停止状態
  - ゲーム速度
  - リージョン情報
  - ユニット情報
  - リソース(食料/金)

#### キャッシュシステム (`cache_manager.py`)
- マップサーフェスキャッシュ
- ズームマップキャッシュ
- 選択リージョンオーバーレイキャッシュ
- 日付変更時の自動無効化

---

### 8. ゲームループ (`game1.py`)

#### 時間システム
- **1日 = 1000 ticks**
- **ゲーム速度**: 1x, 2x, 4x
- **一時停止**: スペースキーでトグル

#### 入力処理 (`input_handler.py`)
- **マウス**: ユニット選択、移動指示、リージョン選択
- **キーボード**:
  - スペース: 一時停止
  - 1/2/3: ゲーム速度変更
  - F: 霧デバッグトグル
  - W: ワールドビュー
  - Z: ズームビュー
  - 矢印キー: ズーム時のスクロール

#### ダブルクリック検出
- 0.3秒以内の2回クリック
- ユニット選択時にズームビューに切り替え

---

## 技術仕様

### ファイル構成

```
pygamegame1/
├── game1.py              # メインゲームループ
├── state.py              # ゲーム状態管理
├── config.py             # 設定定数
├── mapgen.py             # マップ生成
├── faction.py            # 勢力システム
├── unit.py               # ユニットシステム
├── conquest.py           # 征服システム
├── resource_gen.py       # リソース生成
├── render_map.py         # マップレンダリング
├── render_ui.py          # UIレンダリング
├── render_utils.py       # レンダリングユーティリティ
├── input_handler.py      # 入力処理
├── cache_manager.py      # キャッシュ管理
├── audio.py              # オーディオ管理
├── game_system.py        # ゲームシステム統合
└── assets/               # アセット(BGM等)
```

### 主要データ構造

#### GameState (`state.py`)
```python
@dataclass
class GameState:
    # マップデータ
    biome_grid: List[List[str]]
    region_grid: List[List[int]]
    region_seeds: List[Tuple[int, int]]
    region_info: List[dict]
    
    # 勢力データ
    factions: List[Faction]
    player_faction_id: int
    
    # ユニット
    units: List[Unit]
    
    # 霧システム
    fog_grid: List[List[bool]]
    
    # ゲーム時間
    game_time: float
    day: int
    game_speed: float
    is_paused: bool
    
    # リソース
    resource_nodes: List[ResourceNode]
    
    # 征服追跡
    territory_expansion_regions: dict
```

#### Faction (`faction.py`)
```python
class Faction:
    faction_id: int
    name: str
    faction_type: FactionType
    color: tuple
    is_player: bool
    territory_mask: Set[tuple]
    controlled_regions: Set[int]
    food: int
    gold: int
    units: List
```

---

## 実装済み機能

### コア機能
- ✅ プロシージャルマップ生成
- ✅ リージョンシステム
- ✅ 勢力システム(プレイヤー + AI帝国)
- ✅ 4種類のユニット
- ✅ 霧システム
- ✅ 自動探索
- ✅ 征服システム
- ✅ リソース生成
- ✅ ズーム/ワールドビュー切り替え

### UI機能
- ✅ リージョン情報表示
- ✅ ユニット情報表示
- ✅ ゲーム速度制御
- ✅ 一時停止
- ✅ 確認ダイアログ

### デバッグ機能
- ✅ デバッグマップ保存/読み込み
- ✅ 霧オフモード
- ✅ 右クリック即座探索

---

## 未実装機能

### ゲームプレイ
- ⏳ 開拓者による入植システム
- ⏳ 外交官による外交システム
- ⏳ AI勢力の行動ロジック
- ⏳ 勢力間の戦闘
- ⏳ リソースの使用用途
- ⏳ 技術研究
- ⏳ 建物建設

### UI
- ⏳ スタート画面の改善
- ⏳ ゲームオーバー/勝利条件
- ⏳ セーブ/ロード機能
- ⏳ ミニマップ

---

## 設計思想

### モジュール性
各システムが独立したファイルに分離され、明確な責任分担

### データ駆動設計
- リソースタイプは`config.py`で定義
- バイオーム、ユニットタイプも設定ファイルで管理

### パフォーマンス最適化
- レンダリングキャッシュ
- 日次更新のみの処理(征服拡張等)
- 必要時のみキャッシュ無効化

### ユーザー体験
- 自動探索による手間の削減
- ズームモードでの詳細確認
- ゲーム速度調整による快適なプレイ

---

## 今後の開発方向性

### 短期目標
1. AI勢力の基本的な行動実装
2. 開拓者による入植システム
3. リソースの使用用途追加

### 中期目標
1. 外交システムの実装
2. 勢力間の戦闘システム
3. 技術研究ツリー

### 長期目標
1. 複雑なAI戦略
2. マルチプレイヤー対応
3. モッディングサポート
